(function(k,b){var l=function(a,c){this.editor=a;this.options=b.extend({},{source:[],delay:500,queryBy:"name",items:10},c);this.matcher=this.options.matcher||this.matcher;this.renderDropdown=this.options.renderDropdown||this.renderDropdown;this.render=this.options.render||this.render;this.insert=this.options.insert||this.insert;this.highlighter=this.options.highlighter||this.highlighter;this.query="";this.hasFocus=!0;this.renderInput();this.bindEvents()};l.prototype={constructor:l,renderInput:function(){this.editor.execCommand("mceInsertContent",
!1,'<span id="autocomplete"><span id="autocomplete-delimiter">'+this.options.delimiter+'</span><span id="autocomplete-searchtext"><span class="dummy">\ufeff</span></span></span>');this.editor.focus();this.editor.selection.select(this.editor.selection.dom.select("span#autocomplete-searchtext span")[0]);this.editor.selection.collapse(0)},bindEvents:function(){this.editor.on("keyup",this.editorKeyUpProxy=b.proxy(this.rteKeyUp,this));this.editor.on("keydown",this.editorKeyDownProxy=b.proxy(this.rteKeyDown,
this),!0);this.editor.on("click",this.editorClickProxy=b.proxy(this.rteClicked,this));b("body").on("click",this.bodyClickProxy=b.proxy(this.rteLostFocus,this));b(this.editor.getWin()).on("scroll",this.rteScroll=b.proxy(function(){this.cleanUp(!0)},this))},unbindEvents:function(){this.editor.off("keyup",this.editorKeyUpProxy);this.editor.off("keydown",this.editorKeyDownProxy);this.editor.off("click",this.editorClickProxy);b("body").off("click",this.bodyClickProxy);b(this.editor.getWin()).off("scroll",
this.rteScroll)},rteKeyUp:function(a){switch(a.which||a.keyCode){case 40:case 38:case 16:case 17:case 18:break;case 8:""===this.query?this.cleanUp(!0):this.lookup();break;case 9:case 13:a=void 0!==this.$dropdown?this.$dropdown.find("li.active"):[];a.length?(this.select(a.data()),this.cleanUp(!1)):this.cleanUp(!0);break;case 27:this.cleanUp(!0);break;default:this.lookup()}},rteKeyDown:function(a){switch(a.which||a.keyCode){case 9:case 13:case 27:a.preventDefault();break;case 38:a.preventDefault();
void 0!==this.$dropdown&&this.highlightPreviousResult();break;case 40:a.preventDefault(),void 0!==this.$dropdown&&this.highlightNextResult()}a.stopPropagation()},rteClicked:function(a){a=b(a.target);this.hasFocus&&"autocomplete-searchtext"!==a.parent().attr("id")&&this.cleanUp(!0)},rteLostFocus:function(){this.hasFocus&&this.cleanUp(!0)},lookup:function(){this.query=b.trim(b(this.editor.getBody()).find("#autocomplete-searchtext").text()).replace("\ufeff","");void 0===this.$dropdown&&this.show();clearTimeout(this.searchTimeout);
this.searchTimeout=setTimeout(b.proxy(function(){var a=b.isFunction(this.options.source)?this.options.source(this.query,b.proxy(this.process,this),this.options.delimiter):this.options.source;a&&this.process(a)},this),this.options.delay)},matcher:function(a){return~a[this.options.queryBy].toLowerCase().indexOf(this.query.toLowerCase())},sorter:function(a){for(var b=[],d=[],e=[],f;void 0!==(f=a.shift());)f[this.options.queryBy].toLowerCase().indexOf(this.query.toLowerCase())?~f[this.options.queryBy].indexOf(this.query)?
d.push(f):e.push(f):b.push(f);return b.concat(d,e)},highlighter:function(a){return a.replace(new RegExp("("+this.query.replace(/([.?*+^$[\]\\(){}|-])/g,"\\$1")+")","ig"),function(a,b){return"<strong>"+b+"</strong>"})},show:function(){var a=this.editor.inline?this.offsetInline():this.offset();this.$dropdown=b(this.renderDropdown()).css({top:a.top,left:a.left});b("body").append(this.$dropdown);this.$dropdown.on("click",b.proxy(this.autoCompleteClick,this))},process:function(a){if(this.hasFocus){var c=
this,d=[],e=b.grep(a,function(a){return c.matcher(a)}),e=c.sorter(e),e=e.slice(0,this.options.items);b.each(e,function(a,g){var h=b(c.render(g));h.html(h.html().replace(h.text(),c.highlighter(h.text())));b.each(e[a],function(a,b){h.attr("data-"+a,b)});d.push(h[0].outerHTML)});d.length?this.$dropdown.html(d.join("")).show():this.$dropdown.hide()}},renderDropdown:function(){return'<ul class="rte-autocomplete dropdown-menu"><li class="loading"></li></ul>'},render:function(a){return'<li><a href="javascript:;"><span>'+
a[this.options.queryBy]+"</span></a></li>"},autoCompleteClick:function(a){var c=b(a.target).closest("li").data();b.isEmptyObject(c)||(this.select(c),this.cleanUp(!1));a.stopPropagation();a.preventDefault()},highlightPreviousResult:function(){var a=this.$dropdown.find("li.active").index(),a=0===a?this.$dropdown.find("li").length-1:--a;this.$dropdown.find("li").removeClass("active").eq(a).addClass("active")},highlightNextResult:function(){var a=this.$dropdown.find("li.active").index(),a=a===this.$dropdown.find("li").length-
1?0:++a;this.$dropdown.find("li").removeClass("active").eq(a).addClass("active")},select:function(a){this.editor.focus();var b=this.editor.dom.select("span#autocomplete")[0];this.editor.dom.remove(b);this.editor.execCommand("mceInsertContent",!1,this.insert(a))},insert:function(a){return"<span>"+a[this.options.queryBy]+"</span>&nbsp;"},cleanUp:function(a){this.unbindEvents();this.hasFocus=!1;void 0!==this.$dropdown&&(this.$dropdown.remove(),delete this.$dropdown);if(a){var c=this.query;a=b(this.editor.dom.select("span#autocomplete"));
var c=b("<p>"+this.options.delimiter+c+"</p>")[0].firstChild,d=b(this.editor.selection.getNode()).offset().top===a.offset().top+(a.outerHeight()-a.height())/2;this.editor.dom.replace(c,a[0]);d&&(this.editor.selection.select(c),this.editor.selection.collapse())}},offset:function(){var a=b(this.editor.getContainer()).offset(),c=b(this.editor.getContentAreaContainer()).position(),d=b(this.editor.dom.select("span#autocomplete")).position();return{top:a.top+c.top+d.top+b(this.editor.selection.getNode()).innerHeight()-
b(this.editor.getDoc()).scrollTop()+5,left:a.left+c.left+d.left}},offsetInline:function(){var a=b(this.editor.dom.select("span#autocomplete")).offset();return{top:a.top+b(this.editor.selection.getNode()).innerHeight()+5,left:a.left}}};k.create("tinymce.plugins.Mention",{init:function(a){var c,d=a.getParam("mentions");d.delimiter=void 0!==d.delimiter?b.isArray(d.delimiter)?d.delimiter:[d.delimiter]:["@"];a.on("keypress",function(e){var f=b.inArray(String.fromCharCode(e.which||e.keyCode),d.delimiter),
g;if(g=-1<f)g=a.selection.getRng(!0).startOffset,g=(a.selection.getRng(!0).startContainer.data||"").substr(g-1,1),g=b.trim(g).length?!1:!0;g&&(void 0===c||void 0!==c.hasFocus&&!c.hasFocus)&&(e.preventDefault(),c=new l(a,b.extend({},d,{delimiter:d.delimiter[f]})))})},getInfo:function(){return{longname:"mention",author:"Steven Devooght",version:k.majorVersion+"."+k.minorVersion}}});k.PluginManager.add("mention",k.plugins.Mention)})(tinymce,jQuery);